{"parents": [{"link": "../../../", "title": "Module code"}], "title": "steamship.utils.kv_store", "body": "<h1>Source code for steamship.utils.kv_store</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"sd\">&quot;&quot;&quot;A simple key-value store implemented atop Files and Tags.&quot;&quot;&quot;</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">typing</span> <span class=\"kn\">import</span> <span class=\"n\">Any</span><span class=\"p\">,</span> <span class=\"n\">Dict</span><span class=\"p\">,</span> <span class=\"n\">List</span><span class=\"p\">,</span> <span class=\"n\">Optional</span><span class=\"p\">,</span> <span class=\"n\">Tuple</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">steamship</span> <span class=\"kn\">import</span> <span class=\"n\">Block</span><span class=\"p\">,</span> <span class=\"n\">File</span><span class=\"p\">,</span> <span class=\"n\">Steamship</span><span class=\"p\">,</span> <span class=\"n\">Tag</span>\n\n<span class=\"n\">KV_STORE_MARKER</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;__init__&quot;</span>\n\n\n<div class=\"viewcode-block\" id=\"KeyValueStore\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.utils/#steamship.utils.kv_store.KeyValueStore\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">KeyValueStore</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;A simple key value store implemented in Steamship.</span>\n\n<span class=\"sd\">    Instances of the KeyValueStore are identified by its  `namespace`.</span>\n<span class=\"sd\">    This store_identifier corresponds to a File that will be created with a special tag identifying it.</span>\n\n<span class=\"sd\">    Entries of the KeyValueStore are saved as `Tag` objects with:</span>\n<span class=\"sd\">      * Kind = &quot;KeyValueStore&quot;</span>\n<span class=\"sd\">      * Name = the key of the (kv) pair</span>\n<span class=\"sd\">      * Value = a dict set to the value</span>\n\n<span class=\"sd\">    Note that the value is always saved as a dict object. To save a string or int, wrap it in a dict.</span>\n\n<span class=\"sd\">    WARNING:</span>\n\n<span class=\"sd\">    This is essentially a clever hack atop Steamship&#39;s tag system to provide mutable key-value storage. It is in the</span>\n<span class=\"sd\">    steamship.utils package because it&#39;s proven useful once or twice. But in general, if you find yourself heavily</span>\n<span class=\"sd\">    relying upon it, consider reaching out to us at hello@steamship.com to let us know, and we&#39;ll up-prioritize</span>\n<span class=\"sd\">    adding a proper key-value API.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">client</span><span class=\"p\">:</span> <span class=\"n\">Steamship</span>\n    <span class=\"n\">store_identifier</span><span class=\"p\">:</span> <span class=\"nb\">str</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">client</span><span class=\"p\">:</span> <span class=\"n\">Steamship</span><span class=\"p\">,</span> <span class=\"n\">store_identifier</span><span class=\"p\">:</span> <span class=\"nb\">str</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;KeyValueStore&quot;</span><span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Create a new KeyValueStore instance.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            client (Steamship): The Steamship client.</span>\n<span class=\"sd\">            store_identifier (str): The store_identifier which identifies this KeyValueStore instance. You can have multiple, separate KeyValueStore instances in a workspace using this implementation.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">client</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_identifier</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;kv-store-</span><span class=\"si\">{</span><span class=\"n\">store_identifier</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_file</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">or_create</span><span class=\"p\">:</span> <span class=\"nb\">bool</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">File</span><span class=\"p\">]:</span>\n        <span class=\"n\">status_files</span> <span class=\"o\">=</span> <span class=\"n\">File</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s1\">&#39;filetag and kind &quot;</span><span class=\"si\">{</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_identifier</span><span class=\"si\">}</span><span class=\"s1\">&quot;&#39;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">files</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">status_files</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">or_create</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"kc\">None</span>\n            <span class=\"k\">return</span> <span class=\"n\">File</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"p\">,</span>\n                <span class=\"n\">blocks</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">Block</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">)],</span>\n                <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">Tag</span><span class=\"p\">(</span><span class=\"n\">kind</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_identifier</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">KV_STORE_MARKER</span><span class=\"p\">)],</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">status_files</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n<div class=\"viewcode-block\" id=\"KeyValueStore.get\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.utils/#steamship.utils.kv_store.KeyValueStore.get\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Dict</span><span class=\"p\">]:</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Get the value represented by `key`.&quot;&quot;&quot;</span>\n        <span class=\"n\">file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_file</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">file</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">kind</span> <span class=\"o\">==</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_identifier</span> <span class=\"ow\">and</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"n\">key</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">value</span></div>\n\n<div class=\"viewcode-block\" id=\"KeyValueStore.delete\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.utils/#steamship.utils.kv_store.KeyValueStore.delete\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">delete</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"nb\">bool</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Delete the entry represented by `key`&quot;&quot;&quot;</span>\n        <span class=\"n\">file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_file</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">file</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"n\">deleted</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"k\">for</span> <span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">kind</span> <span class=\"o\">==</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_identifier</span> <span class=\"ow\">and</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"n\">key</span><span class=\"p\">:</span>\n                <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span>\n                <span class=\"n\">deleted</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">deleted</span></div>\n\n<div class=\"viewcode-block\" id=\"KeyValueStore.set\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.utils/#steamship.utils.kv_store.KeyValueStore.set\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">set</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">:</span> <span class=\"n\">Dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Any</span><span class=\"p\">]):</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Set the entry (key, value).&quot;&quot;&quot;</span>\n\n        <span class=\"c1\"># First delete it if it exists to avoid duplicate tags.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Now get/create the file</span>\n        <span class=\"n\">file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_file</span><span class=\"p\">(</span><span class=\"n\">or_create</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n        <span class=\"n\">req</span> <span class=\"o\">=</span> <span class=\"n\">Tag</span><span class=\"p\">(</span><span class=\"n\">file_id</span><span class=\"o\">=</span><span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">kind</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_identifier</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span><span class=\"s2\">&quot;tag/create&quot;</span><span class=\"p\">,</span> <span class=\"n\">req</span><span class=\"p\">,</span> <span class=\"n\">expect</span><span class=\"o\">=</span><span class=\"n\">Tag</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"KeyValueStore.items\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.utils/#steamship.utils.kv_store.KeyValueStore.items\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">items</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filter_keys</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">List</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"n\">List</span><span class=\"p\">[</span><span class=\"n\">Tuple</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Any</span><span class=\"p\">]]]:</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Return all key-value entries as a list of (key, value) tuples.</span>\n\n<span class=\"sd\">        If `filter_keys` is provided, only returns keys within that list.&quot;&quot;&quot;</span>\n\n        <span class=\"n\">file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_file</span><span class=\"p\">(</span><span class=\"n\">or_create</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"p\">[</span>\n            <span class=\"p\">(</span><span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">tags</span>\n            <span class=\"k\">if</span> <span class=\"p\">(</span>\n                <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">kind</span> <span class=\"o\">==</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_identifier</span>\n                <span class=\"ow\">and</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">!=</span> <span class=\"n\">KV_STORE_MARKER</span>\n                <span class=\"ow\">and</span> <span class=\"p\">(</span><span class=\"n\">filter_keys</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">filter_keys</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">]</span></div>\n\n<div class=\"viewcode-block\" id=\"KeyValueStore.reset\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.utils/#steamship.utils.kv_store.KeyValueStore.reset\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">reset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n<span class=\"w\">        </span><span class=\"sd\">&quot;&quot;&quot;Delete all key-values.&quot;&quot;&quot;</span>\n        <span class=\"n\">file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_file</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">file</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">file</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span></div></div>\n</pre></div>", "current_page_name": "_modules/steamship/utils/kv_store", "sidebars": ["sidebar/brand.html", "sidebar/search.html", "sidebar/scroll-start.html", "sidebar/navigation.html", "sidebar/ethical-ads.html", "sidebar/scroll-end.html", "sidebar/variant-selector.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.12", "furo_version": "2023.03.27", "furo_navigation_tree": "", "furo_hide_toc": true, "furo_pygments": {"light": {"background": "#f8f8f8", "foreground": "black"}, "dark": {"background": "#272822", "foreground": "#f8f8f2"}}}