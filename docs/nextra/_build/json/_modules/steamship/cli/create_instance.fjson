{"parents": [{"link": "../../../", "title": "Module code"}], "title": "steamship.cli.create_instance", "body": "<h1>Source code for steamship.cli.create_instance</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">json</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">from</span> <span class=\"nn\">json</span> <span class=\"kn\">import</span> <span class=\"n\">JSONDecodeError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">os</span> <span class=\"kn\">import</span> <span class=\"n\">path</span>\n<span class=\"kn\">from</span> <span class=\"nn\">pathlib</span> <span class=\"kn\">import</span> <span class=\"n\">Path</span>\n<span class=\"kn\">from</span> <span class=\"nn\">typing</span> <span class=\"kn\">import</span> <span class=\"n\">Any</span><span class=\"p\">,</span> <span class=\"n\">Callable</span><span class=\"p\">,</span> <span class=\"n\">Dict</span><span class=\"p\">,</span> <span class=\"n\">Optional</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">click</span>\n<span class=\"kn\">from</span> <span class=\"nn\">pydantic</span> <span class=\"kn\">import</span> <span class=\"n\">ValidationError</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">steamship</span> <span class=\"kn\">import</span> <span class=\"n\">Steamship</span><span class=\"p\">,</span> <span class=\"n\">SteamshipError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">steamship.cli.ship_spinner</span> <span class=\"kn\">import</span> <span class=\"n\">ship_spinner</span>\n<span class=\"kn\">from</span> <span class=\"nn\">steamship.data.manifest</span> <span class=\"kn\">import</span> <span class=\"n\">DeployableType</span><span class=\"p\">,</span> <span class=\"n\">Manifest</span>\n<span class=\"kn\">from</span> <span class=\"nn\">steamship.utils.metadata</span> <span class=\"kn\">import</span> <span class=\"n\">hash_dict</span>\n<span class=\"kn\">from</span> <span class=\"nn\">steamship.utils.utils</span> <span class=\"kn\">import</span> <span class=\"n\">create_instance_handle</span>\n\n\n<div class=\"viewcode-block\" id=\"LoggingDisabled\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.cli/#steamship.cli.create_instance.LoggingDisabled\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">LoggingDisabled</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Context manager that turns off logging within context.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__enter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">disable</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">CRITICAL</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">exit_type</span><span class=\"p\">,</span> <span class=\"n\">exit_value</span><span class=\"p\">,</span> <span class=\"n\">exit_traceback</span><span class=\"p\">):</span>\n        <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">disable</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">NOTSET</span><span class=\"p\">)</span></div>\n\n\n<span class=\"nd\">@click</span><span class=\"o\">.</span><span class=\"n\">command</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;use&quot;</span><span class=\"p\">)</span>\n<span class=\"nd\">@click</span><span class=\"o\">.</span><span class=\"n\">option</span><span class=\"p\">(</span>\n    <span class=\"s2\">&quot;--workspace&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;-w&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">,</span>\n    <span class=\"n\">help</span><span class=\"o\">=</span><span class=\"s2\">&quot;Workspace handle. The new instance will be created in this workspace. If not specified, &quot;</span>\n    <span class=\"s2\">&quot;the default workspace will be used.&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"nd\">@click</span><span class=\"o\">.</span><span class=\"n\">option</span><span class=\"p\">(</span>\n    <span class=\"s2\">&quot;--instance_handle&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;-i&quot;</span><span class=\"p\">,</span>\n    <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">,</span>\n    <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">help</span><span class=\"o\">=</span><span class=\"s2\">&quot;Instance handle. Used to name the instance (if it needs to be created). If not specified, &quot;</span>\n    <span class=\"s2\">&quot;a generated instance name will be used.&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"nd\">@click</span><span class=\"o\">.</span><span class=\"n\">option</span><span class=\"p\">(</span>\n    <span class=\"s2\">&quot;--config&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;-c&quot;</span><span class=\"p\">,</span>\n    <span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">,</span>\n    <span class=\"n\">required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n    <span class=\"n\">help</span><span class=\"o\">=</span><span class=\"s2\">&quot;Instance configuration. May be inline JSON or a path to a file. If not specified, &quot;</span>\n    <span class=\"s2\">&quot;an empty configuration dictionary will be passed to the instance.&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">create_instance</span><span class=\"p\">(</span>\n    <span class=\"n\">workspace</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">instance_handle</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">config</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Create an instance of your package/plugin for use.</span>\n\n<span class=\"sd\">    Must be run from a directory containing a Steamship manifest.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">with</span> <span class=\"n\">LoggingDisabled</span><span class=\"p\">():</span>  <span class=\"c1\"># keep CLI output as concise as possible</span>\n        <span class=\"k\">return</span> <span class=\"n\">_create_instance</span><span class=\"p\">(</span><span class=\"n\">workspace</span><span class=\"o\">=</span><span class=\"n\">workspace</span><span class=\"p\">,</span> <span class=\"n\">instance_handle</span><span class=\"o\">=</span><span class=\"n\">instance_handle</span><span class=\"p\">,</span> <span class=\"n\">config</span><span class=\"o\">=</span><span class=\"n\">config</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_create_instance</span><span class=\"p\">(</span>  <span class=\"c1\"># noqa: C901</span>\n    <span class=\"n\">workspace</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">instance_handle</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">config</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"n\">manifest</span> <span class=\"o\">=</span> <span class=\"n\">load_manifest</span><span class=\"p\">()</span>\n    <span class=\"n\">invocable_config</span><span class=\"p\">,</span> <span class=\"n\">is_file</span> <span class=\"o\">=</span> <span class=\"n\">config_str_to_dict</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span>\n    <span class=\"n\">set_unset_params</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">,</span> <span class=\"n\">invocable_config</span><span class=\"p\">,</span> <span class=\"n\">is_file</span><span class=\"p\">,</span> <span class=\"n\">manifest</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">workspace</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">workspace</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n        <span class=\"n\">ws_hash</span> <span class=\"o\">=</span> <span class=\"n\">hash_dict</span><span class=\"p\">(</span>\n            <span class=\"p\">{</span>\n                <span class=\"o\">**</span><span class=\"n\">invocable_config</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;version&quot;</span><span class=\"p\">:</span> <span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">version</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;invocable&quot;</span><span class=\"p\">:</span> <span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"p\">,</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">workspace</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;space-</span><span class=\"si\">{</span><span class=\"n\">ws_hash</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">Steamship</span><span class=\"p\">(</span><span class=\"n\">workspace</span><span class=\"o\">=</span><span class=\"n\">workspace</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">SteamshipError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">get_current_context</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">abort</span><span class=\"p\">()</span>\n\n    <span class=\"n\">create_instance_fn</span> <span class=\"o\">=</span> <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">use</span>\n    <span class=\"k\">if</span> <span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">type</span> <span class=\"o\">==</span> <span class=\"n\">DeployableType</span><span class=\"o\">.</span><span class=\"n\">PLUGIN</span><span class=\"p\">:</span>\n        <span class=\"n\">create_instance_fn</span> <span class=\"o\">=</span> <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">use_plugin</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">instance_handle</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">instance_handle</span> <span class=\"o\">=</span> <span class=\"n\">create_instance_handle</span><span class=\"p\">(</span>\n            <span class=\"n\">invocable_handle</span><span class=\"o\">=</span><span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"p\">,</span>\n            <span class=\"n\">version_handle</span><span class=\"o\">=</span><span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">version</span><span class=\"p\">,</span>\n            <span class=\"n\">invocable_config</span><span class=\"o\">=</span><span class=\"n\">invocable_config</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">_call_create_instance_fn</span><span class=\"p\">(</span>\n            <span class=\"n\">client</span><span class=\"p\">,</span> <span class=\"n\">manifest</span><span class=\"p\">,</span> <span class=\"n\">instance_handle</span><span class=\"p\">,</span> <span class=\"n\">invocable_config</span><span class=\"p\">,</span> <span class=\"n\">create_instance_fn</span>\n        <span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">SteamshipError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"s2\">&quot;Configuration for this PackageInstance is invalid.&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">e</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">:</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">The configuration for this Package instance was invalid. &quot;</span>\n                <span class=\"s2\">&quot;This usually means it contains some required configuration fields.&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;Create one interactively on the web at:</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;   https://steamship.com/packages/</span><span class=\"si\">{</span><span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"si\">}</span><span class=\"s2\">/_create</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">Failed to create instance: </span><span class=\"si\">{</span><span class=\"n\">e</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">get_current_context</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">abort</span><span class=\"p\">()</span>\n\n\n<div class=\"viewcode-block\" id=\"load_manifest\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.cli/#steamship.cli.create_instance.load_manifest\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">load_manifest</span><span class=\"p\">():</span>\n    <span class=\"n\">manifest</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">if</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">(</span><span class=\"s2\">&quot;steamship.json&quot;</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">manifest</span> <span class=\"o\">=</span> <span class=\"n\">Manifest</span><span class=\"o\">.</span><span class=\"n\">load_manifest</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span> <span class=\"n\">ValidationError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;This package had an invalid steamship.json file.&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">e</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">get_current_context</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">abort</span><span class=\"p\">()</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;No manifest found for instance creation.&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;Please try again from a directory with a package or plugin manifest.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">get_current_context</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">abort</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"n\">manifest</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;Steamship manifest failed to load.&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">get_current_context</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">abort</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">manifest</span></div>\n\n\n<div class=\"viewcode-block\" id=\"set_unset_params\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.cli/#steamship.cli.create_instance.set_unset_params\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">set_unset_params</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">,</span> <span class=\"n\">invocable_config</span><span class=\"p\">,</span> <span class=\"n\">is_file</span><span class=\"p\">,</span> <span class=\"n\">manifest</span><span class=\"p\">):</span>\n    <span class=\"n\">new_param_values</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n    <span class=\"k\">for</span> <span class=\"n\">param</span><span class=\"p\">,</span> <span class=\"n\">param_config</span> <span class=\"ow\">in</span> <span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">configTemplate</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">param</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">invocable_config</span> <span class=\"ow\">and</span> <span class=\"p\">(</span>\n            <span class=\"n\">param_config</span><span class=\"o\">.</span><span class=\"n\">default</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">param_config</span><span class=\"o\">.</span><span class=\"n\">default</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;&quot;</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">param</span><span class=\"o\">.</span><span class=\"n\">upper</span><span class=\"p\">()</span> <span class=\"ow\">in</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">environ</span><span class=\"p\">:</span>\n                <span class=\"n\">invocable_config</span><span class=\"p\">[</span><span class=\"n\">param</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">environ</span><span class=\"p\">[</span><span class=\"n\">param</span><span class=\"o\">.</span><span class=\"n\">upper</span><span class=\"p\">()]</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">invocable_config</span><span class=\"p\">[</span><span class=\"n\">param</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">prompt</span><span class=\"p\">(</span>\n                    <span class=\"sa\">f</span><span class=\"s2\">&quot;Value for </span><span class=\"si\">{</span><span class=\"n\">param</span><span class=\"si\">}</span><span class=\"s2\"> (</span><span class=\"si\">{</span><span class=\"n\">param_config</span><span class=\"o\">.</span><span class=\"n\">description</span><span class=\"si\">}</span><span class=\"s2\">)&quot;</span>\n                    <span class=\"o\">+</span> <span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">Press Enter for DEFAULT&quot;</span> <span class=\"k\">if</span> <span class=\"n\">param_config</span><span class=\"o\">.</span><span class=\"n\">default</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;&quot;</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">),</span>\n                    <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"n\">new_param_values</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"k\">if</span> <span class=\"n\">is_file</span> <span class=\"ow\">and</span> <span class=\"n\">new_param_values</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span>\n            <span class=\"sa\">f</span><span class=\"s2\">&quot;Do you want to store this config in your config file (</span><span class=\"si\">{</span><span class=\"n\">config</span><span class=\"si\">}</span><span class=\"s2\">)?&quot;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dump</span><span class=\"p\">(</span><span class=\"n\">invocable_config</span><span class=\"p\">,</span> <span class=\"n\">Path</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"s2\">&quot;w&quot;</span><span class=\"p\">))</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;Successfully wrote configuration </span><span class=\"si\">{</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s2\"> to </span><span class=\"si\">{</span><span class=\"n\">config</span><span class=\"si\">}</span><span class=\"s2\">.&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span>\n            <span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_call_create_instance_fn</span><span class=\"p\">(</span>\n    <span class=\"n\">client</span><span class=\"p\">:</span> <span class=\"n\">Steamship</span><span class=\"p\">,</span>\n    <span class=\"n\">manifest</span><span class=\"p\">:</span> <span class=\"n\">Manifest</span><span class=\"p\">,</span>\n    <span class=\"n\">instance</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span>\n    <span class=\"n\">config</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"n\">Dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Any</span><span class=\"p\">]],</span>\n    <span class=\"n\">create_instance_fn</span><span class=\"p\">:</span> <span class=\"n\">Callable</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;&quot;&quot;&quot;</span>\n    <span class=\"n\">workspace_handle</span> <span class=\"o\">=</span> <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">get_workspace</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">handle</span>\n\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span><span class=\"s2\">&quot;Using values:</span><span class=\"se\">\\n</span><span class=\"s2\">- Workspace: &quot;</span><span class=\"p\">,</span> <span class=\"n\">nl</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">workspace_handle</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;- </span><span class=\"si\">{</span><span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">type</span><span class=\"o\">.</span><span class=\"n\">title</span><span class=\"p\">()</span><span class=\"si\">}</span><span class=\"s2\">: &quot;</span><span class=\"p\">,</span> <span class=\"n\">nl</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span><span class=\"s2\">&quot;- Version: &quot;</span><span class=\"p\">,</span> <span class=\"n\">nl</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">version</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span><span class=\"s2\">&quot;- Instance Handle: &quot;</span><span class=\"p\">,</span> <span class=\"n\">nl</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">instance</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span><span class=\"s2\">&quot;- Configuration: &quot;</span><span class=\"p\">,</span> <span class=\"n\">nl</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span><span class=\"s2\">&quot;Creating new (or fetching existing) instance: &quot;</span><span class=\"p\">,</span> <span class=\"n\">nl</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n    <span class=\"k\">with</span> <span class=\"n\">ship_spinner</span><span class=\"p\">():</span>\n        <span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">create_instance_fn</span><span class=\"p\">(</span>\n            <span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"p\">,</span>\n            <span class=\"n\">instance_handle</span><span class=\"o\">=</span><span class=\"n\">instance</span><span class=\"p\">,</span>\n            <span class=\"n\">version</span><span class=\"o\">=</span><span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">version</span><span class=\"p\">,</span>\n            <span class=\"n\">config</span><span class=\"o\">=</span><span class=\"n\">config</span><span class=\"p\">,</span>\n            <span class=\"n\">wait_for_init</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">instance</span><span class=\"p\">:</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">Success!&quot;</span><span class=\"p\">,</span> <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;green&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">manifest</span><span class=\"o\">.</span><span class=\"n\">type</span> <span class=\"o\">==</span> <span class=\"n\">DeployableType</span><span class=\"o\">.</span><span class=\"n\">PACKAGE</span><span class=\"p\">:</span>\n                <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span>\n                    <span class=\"sa\">f</span><span class=\"s2\">&quot;Web URL: https://steamship.com/workspaces/</span><span class=\"si\">{</span><span class=\"n\">workspace_handle</span><span class=\"si\">}</span><span class=\"s2\">/packages/</span><span class=\"si\">{</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">handle</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">echo</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;API URL: </span><span class=\"si\">{</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">invocation_url</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n                <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">SteamshipError</span><span class=\"p\">(</span><span class=\"s2\">&quot;instance creation unexpectedly returned empty instance.&quot;</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"cannot_parse_config\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.cli/#steamship.cli.create_instance.cannot_parse_config\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">cannot_parse_config</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">exception</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"ne\">Exception</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"n\">exception_str</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;: </span><span class=\"si\">{</span><span class=\"n\">exception</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span> <span class=\"k\">if</span> <span class=\"n\">exception</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">secho</span><span class=\"p\">(</span>\n        <span class=\"sa\">f</span><span class=\"s2\">&quot;Could not parse configuration </span><span class=\"si\">{</span><span class=\"n\">config</span><span class=\"si\">}</span><span class=\"s2\"> as a file or JSON string</span><span class=\"si\">{</span><span class=\"n\">exception_str</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">fg</span><span class=\"o\">=</span><span class=\"s2\">&quot;red&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">get_current_context</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">abort</span><span class=\"p\">()</span></div>\n\n\n<div class=\"viewcode-block\" id=\"config_str_to_dict\"><a class=\"viewcode-back\" href=\"../../../../api/steamship.cli/#steamship.cli.create_instance.config_str_to_dict\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">config_str_to_dict</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">:</span> <span class=\"n\">Optional</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span><span class=\"p\">)</span> <span class=\"o\">-&gt;</span> <span class=\"p\">(</span><span class=\"n\">Dict</span><span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">Any</span><span class=\"p\">],</span> <span class=\"nb\">bool</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"sd\">&quot;&quot;&quot;Convert config string into dict.</span>\n\n<span class=\"sd\">    The input string can be a JSON-string or the name of a file.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">config</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"p\">{},</span> <span class=\"kc\">False</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">json_config</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">json_config</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">):</span>\n            <span class=\"n\">cannot_parse_config</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">json_config</span><span class=\"p\">,</span> <span class=\"kc\">False</span>\n    <span class=\"k\">except</span> <span class=\"n\">JSONDecodeError</span><span class=\"p\">:</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">config_path</span> <span class=\"o\">=</span> <span class=\"n\">Path</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">config_path</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">():</span>\n                <span class=\"k\">if</span> <span class=\"n\">click</span><span class=\"o\">.</span><span class=\"n\">confirm</span><span class=\"p\">(</span>\n                    <span class=\"sa\">f</span><span class=\"s2\">&quot;Configuration file </span><span class=\"si\">{</span><span class=\"n\">config_path</span><span class=\"si\">}</span><span class=\"s2\"> does not exist. Do you want to create it&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                <span class=\"p\">):</span>\n                    <span class=\"n\">config_path</span><span class=\"o\">.</span><span class=\"n\">parent</span><span class=\"o\">.</span><span class=\"n\">mkdir</span><span class=\"p\">(</span><span class=\"n\">parents</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">exist_ok</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n                    <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dump</span><span class=\"p\">({},</span> <span class=\"n\">config_path</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"s2\">&quot;w&quot;</span><span class=\"p\">))</span>\n            <span class=\"n\">file_json</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">config_path</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">())</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">file_json</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">):</span>\n                <span class=\"n\">cannot_parse_config</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">file_json</span><span class=\"p\">,</span> <span class=\"kc\">True</span>\n\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"n\">cannot_parse_config</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">,</span> <span class=\"n\">e</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/steamship/cli/create_instance", "sidebars": ["sidebar/brand.html", "sidebar/search.html", "sidebar/scroll-start.html", "sidebar/navigation.html", "sidebar/ethical-ads.html", "sidebar/scroll-end.html", "sidebar/variant-selector.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.12", "furo_version": "2023.03.27", "furo_navigation_tree": "", "furo_hide_toc": true, "furo_pygments": {"light": {"background": "#f8f8f8", "foreground": "black"}, "dark": {"background": "#272822", "foreground": "#f8f8f2"}}}